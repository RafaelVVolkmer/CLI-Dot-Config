# =========================[ Neofetch config ]=========================
# File: ~/.config/neofetch/config.conf
# =====================================================================

# -----------------------------[ GLOBAL ]------------------------------
CURL_MAX_TIME="2.2"
CURL_CONN_TIME="1.5"
CURL_RETRIES=1
CURL_UA="curl/7.79 neofetch-net"
CURL_LANG="${LANG:-pt-BR,pt;q=0.9,en;q=0.7}"

c() { color "$1"; }
trim_print() { tr -cd '[:print:]\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//'; }
in_wsl() { grep -qi microsoft /proc/version 2>/dev/null; }
curl_q() {
  command -v curl >/dev/null 2>&1 || return 1
  curl -sS --fail --max-time "$CURL_MAX_TIME" --connect-timeout "$CURL_CONN_TIME" \
       --retry "$CURL_RETRIES" -A "$CURL_UA" -H "Accept-Language: $CURL_LANG" \
       "$1" 2>/dev/null
}
ps1_run() { powershell.exe -NoProfile -NonInteractive -Command - 2>/dev/null | tr -d '\r'; }
urlenc_basic() { sed -e 's/ /%20/g'; }

na_or() { [ -n "$1" ] && printf '%s\n' "$1" || printf 'N/A\n'; }

# -------------------------------[ UI ]--------------------------------
ui_header_top() { prin "$(c 12)╭──────────── $(c 10)$1$(c 12) ────────────"; }
ui_header_mid() { prin "$(c 12)├──────────── $(c 10)$1$(c 12) ────────────"; }
ui_div_end()    { prin "$(c 12)╰────────────────────────────────────────────"; }
ui_text()       { prin "$(c 12)│ $(c 14)$1$(c 7) $2"; }
ui_info()       { info "$(c 12)│ $(c 14)$1" "$2"; }

# ---------------------------[ NET HELPERS ]---------------------------
get_dns() {
  local out dev
  if command -v resolvectl >/dev/null 2>&1; then
    dev="$(ip route get 1.1.1.1 2>/dev/null | awk '/ dev /{for(i=1;i<=NF;i++) if($i=="dev"){print $(i+1); exit}}')"
    [ -n "$dev" ] && out="$(resolvectl dns "$dev" 2>/dev/null | awk -F: '{print $2}' | xargs)"
    [ -z "$out" ] && out="$(resolvectl status 2>/dev/null | awk -F: '/Current DNS Server/{print $2}' | xargs)"
  fi
  [ -z "$out" ] && out="$(awk '/^nameserver/{print $2}' /etc/resolv.conf | paste -sd ", " -)"
  [ -n "$out" ] && printf '%s\n' "$out"
}

get_wifi_ssid() {
  if in_wsl; then
    local ssid
    ssid="$(ps1_run <<'PS1'
$ErrorActionPreference = 'SilentlyContinue'

$w = netsh wlan show interfaces
if ($w) {
  $sections = $w -split '\r?\n\r?\n'
  foreach ($s in $sections) {
    if ($s -match '^\s*State\s*:\s*(connected|conectad[oa])' -or $s -match '^\s*Estado\s*:\s*(conectad[oa])') {
      $m = [regex]::Match($s, '^\s*SSID\s*:\s*(.+)$', 'IgnoreCase, Multiline')
      if ($m.Success) { $val = $m.Groups[1].Value.Trim(); if ($val) { $val; exit } }
    }
  }
  # fallback: primeira linha SSID válida (ainda do netsh)
  $m2 = [regex]::Match($w, '^\s*SSID\s*:\s*(.+)$', 'IgnoreCase, Multiline')
  if ($m2.Success) { $v = $m2.Groups[1].Value.Trim(); if ($v) { $v; exit } }
}

$ad = Get-NetAdapter | Where-Object { $_.Status -eq 'Up' -and $_.Name -match 'Wi-?Fi|WLAN|Wireless|802\.11' } | Select-Object -First 1
if ($ad) {
  $prof = Get-NetConnectionProfile | Where-Object { $_.InterfaceIndex -eq $ad.IfIndex } | Select-Object -First 1
  if ($prof -and $prof.Name) { $prof.Name; exit }
}

$ssidBytes = Get-CimInstance -Namespace root\WMI -Class MSNdis_80211_ServiceSetIdentifier |
  Where-Object { $_.Active } | Select-Object -First 1 -ExpandProperty Ndis80211SsId
if ($ssidBytes) { [System.Text.Encoding]::ASCII.GetString($ssidBytes) }
PS1
)"
    [ -n "$ssid" ] && printf '%s\n' "$ssid"
    return
  fi

  if command -v nmcli >/dev/null 2>&1; then
    nmcli -t -f ACTIVE,SSID dev wifi 2>/dev/null | awk -F: '$1=="yes"{print $2; exit}'
  elif command -v iwgetid >/dev/null 2>&1; then
    iwgetid -r 2>/dev/null
  fi
}

get_latency() { ping -n -c1 -W1 1.1.1.1 2>/dev/null | awk -F= '/time=/{print $4}'; }
get_local_ip() {
  if command -v ip >/dev/null 2>&1; then
    ip route get 1.1.1.1 2>/dev/null | awk '/src/ {for(i=1;i<=NF;i++) if($i=="src"){print $(i+1); exit}}'
  fi
}
get_public_ip_and_isp() {
  local pip isp
  pip="$(curl_q "https://ifconfig.me" || true)"
  isp="$(curl_q "https://ipinfo.io/org" | trim_print || true)"
  printf '%s|%s' "$pip" "$isp"
}

# -----------------------------[ TEMPS ]-------------------------------
get_cpu_temp() {
  if in_wsl; then
    local t
    t="$(ps1_run <<'PS1' | head -n1
Try {
  $v = Get-CimInstance -Namespace root\wmi -Class MSAcpi_ThermalZoneTemperature |
       Select-Object -Expand CurrentTemperature |
       Measure-Object -Maximum | Select-Object -Expand Maximum
  if ($v) { [math]::Round(($v/10) - 273.15) }
} Catch { }
PS1
)"
    [ -n "$t" ] && { printf '%s°C\n' "$t"; return; }
  fi
  if command -v sensors >/dev/null 2>&1; then
    sensors 2>/dev/null | awk '
      /^Package id 0:/ {print $3; exit}
      /^Tctl:/         {print $2; exit}
      /^Tdie:/         {print $2; exit}
      /^CPU Temp:/     {print $3; exit}
    ' && return
  fi
  if [ -d /sys/class/thermal ]; then
    awk 'BEGIN{mx=-1}
      /\/temp$/{
        cmd="cat \""$0"\""; cmd|getline n; close(cmd);
        if (n>mx) mx=n
      }
      END{ if (mx>=0) printf "%.0f°C\n", mx/1000 }' \
      <(find /sys/class/thermal -type f -name temp 2>/dev/null) && return
  fi
}
get_gpu_temp() {
  if command -v nvidia-smi >/dev/null 2>&1; then
    nvidia-smi --query-gpu=temperature.gpu --format=csv,noheader 2>/dev/null |
      head -n1 | awk '{print $1 "°C"}'
  fi
}

# -------------------------[ GEO / WEATHER ]---------------------------
get_location_parts() {
  if [ -n "${NEOFETCH_LOCATION:-}" ]; then
    local c r p line
    line="$NEOFETCH_LOCATION"
    c="${line%%,*}"; line="${line#*, }"
    r="${line%% (*}"; p="${line##*(}"; p="${p%)}"
    printf '%s\n%s\n%s\n' "${c:-}" "${r:-}" "${p:-}"
    return
  fi
  command -v curl >/dev/null 2>&1 || return 1
  local json city region country
  json="$(curl_q "https://ipapi.co/json")" || json=""
  if [ -n "$json" ]; then
    if command -v jq >/dev/null 2>&1; then
      city=$(jq -r '.city//empty' <<<"$json")
      region=$(jq -r '.region//empty' <<<"$json")
      country=$(jq -r '.country_name//empty' <<<"$json")
    else
      city=$(printf '%s' "$json" | sed -n 's/.*"city":"\([^"]*\)".*/\1/p' | head -n1)
      region=$(printf '%s' "$json" | sed -n 's/.*"region":"\([^"]*\)".*/\1/p' | head -n1)
      country=$(printf '%s' "$json" | sed -n 's/.*"country_name":"\([^"]*\)".*/\1/p' | head -n1)
    fi
    printf '%s\n%s\n%s\n' "${city:-}" "${region:-}" "${country:-}"
    return
  fi
  city="$(curl_q "https://ipinfo.io/city" | trim_print || true)"
  [ -n "$city" ] && { printf '%s\n\n\n' "$city"; return; }
  return 1
}
get_location_fmt() {
  local city region country out
  { read -r city; read -r region; read -r country; } < <(get_location_parts || printf '\n\n\n')
  [ -n "$city" ]   && out="$city"
  [ -n "$region" ] && out="${out:+$out, }$region"
  [ -n "$country" ]&& out="${out:+$out }($country)"
  printf '%s\n' "$out"
}
get_coords() {
  if [ -n "$NEOFETCH_LAT" ] && [ -n "$NEOFETCH_LON" ]; then
    printf '%s|%s\n' "$NEOFETCH_LAT" "$NEOFETCH_LON"
    return
  fi
  command -v curl >/dev/null 2>&1 || return 1
  local lat lon
  lat="$(curl_q "https://ipapi.co/latitude"  || true)"
  lon="$(curl_q "https://ipapi.co/longitude" || true)"
  [ -n "$lat" ] && [ -n "$lon" ] && printf '%s|%s\n' "$lat" "$lon"
}

get_weather() {
  command -v curl >/dev/null 2>&1 || return 1
  local city encoded resp
  if [ -n "${NEOFETCH_WEATHER_CITY:-}" ]; then
    city="$NEOFETCH_WEATHER_CITY"
  else
    city="$(get_location_fmt)"
  fi
  if [ -n "$city" ]; then
    encoded="$(printf '%s' "$city" | urlenc_basic)"
    resp="$(curl_q "https://wttr.in/${encoded}?format=%c%20%t&m" | trim_print || true)"
    if [ -z "$resp" ] || printf '%s\n' "$resp" | grep -qi 'unknown location'; then
      resp="$(curl_q "https://wttr.in/${encoded}?format=1&m" | trim_print || true)"
    fi
    if [ -n "$resp" ] && ! printf '%s\n' "$resp" | grep -qi 'unknown location'; then
      printf '%s\n' "$resp"; return
    fi
  fi
  local lat lon data temp code
  IFS='|' read -r lat lon <<<"$(get_coords)"
  if [ -n "$lat" ] && [ -n "$lon" ]; then
    data="$(curl_q "https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,weather_code&timezone=auto")"
    if [ -n "$data" ]; then
      temp="$(printf '%s' "$data" | tr -d '\n' | sed -n 's/.*"temperature_2m":\([0-9.\-]\+\).*/\1/p' | head -n1)"
      code="$(printf '%s' "$data" | tr -d '\n' | sed -n 's/.*"weather_code":\([0-9]\+\).*/\1/p' | head -n1)"
      [ -n "$temp" ] && { printf '%s%s°C\n' "$temp"; return; }
    fi
  fi
  resp="$(curl_q "https://wttr.in/?format=1&m" | trim_print || true)"
  [ -n "$resp" ] && printf '%s\n' "$resp"
}

# -----------------------------[ ENV/VM/CT ]---------------------------
virt_and_wsl() {
  local v="" w="no"
  if command -v systemd-detect-virt >/dev/null 2>&1; then
    v="$(systemd-detect-virt 2>/dev/null)"
  fi
  in_wsl && w="yes"
  printf '%s|%s' "$v" "$w"
}
containers_count() {
  local d="0" p="0"
  if command -v docker >/dev/null 2>&1; then
    d="$(docker ps -q 2>/dev/null | wc -l | tr -d ' ')"
  fi
  if command -v podman >/dev/null 2>&1; then
    p="$(podman ps -q 2>/dev/null | wc -l | tr -d ' ')"
  fi
  printf '%s|%s' "$d" "$p"
}

# -----------------------------[ SECTIONS ]----------------------------
section_software() {
  ui_header_top "Software"
  ui_info "OS" distro
  ui_info "Kernel" kernel
  ui_info "Packages" packages
  ui_info "Shell" shell
  ui_info "DE" de
  ui_info "WM" wm
  ui_info "Resolution" resolution
  ui_info "CPU Usage" cpu_usage
  ui_info "Processes" processes
}

section_hardware() {
  ui_header_mid "Hardware"
  ui_info "Host" model
  ui_info "CPU" cpu
  ui_info "GPU" gpu
  ui_info "Memory" memory
  ui_info "Disk" disk
  ui_info "Battery" battery
  local ct gt
  ct="$(get_cpu_temp)"; gt="$(get_gpu_temp)"
  ui_text "Temps" "$(c 7)CPU $(na_or "$ct")  GPU $(na_or "$gt")"
}

section_connection() {
  ui_header_mid "Conexão"
  local dns wifi lat lip pip isp
  dns="$(get_dns)";        ui_text "DNS (auto)" "$(na_or "$dns")"
  wifi="$(get_wifi_ssid)"; ui_text "Wi-Fi"      "$(na_or "$wifi")"
  lat="$(get_latency)";    ui_text "Latency"    "$(na_or "$lat")"
  lip="$(get_local_ip)"; [ -z "$lip" ] && lip="$(hostname -I 2>/dev/null | awk '{print $1}')"
  ui_text "Local IP" "$(na_or "$lip")"
  IFS='|' read -r pip isp <<<"$(get_public_ip_and_isp)"
  local pub_line=""; [ -n "$pip" ] && pub_line="$pip"; [ -n "$isp" ] && pub_line="${pub_line:+$pub_line  }($isp)"
  ui_text "Public IP" "$(na_or "$pub_line")"
}

section_local() {
  ui_header_mid "Local"
  local loc wx
  loc="$(get_location_fmt)"; ui_text "Location" "$(na_or "$loc")"
  wx="$(get_weather)";       ui_text "Weather"  "$(na_or "$wx")"
}

section_ambient() {
  ui_header_mid "Ambiente"
  local v w d p
  IFS='|' read -r v w <<<"$(virt_and_wsl)"
  IFS='|' read -r d p <<<"$(containers_count)"
  ui_text "Virt/WSL" "$( [ -n "$v" ] && printf '%s  ' "$v"; printf 'WSL %s' "$w" )"
  ui_text "Containers" "Docker ${d}  Podman ${p}"
}

section_uptime() {
  ui_header_mid "Uptime"
  ui_info "›" uptime
  ui_div_end
  info cols
}

# -----------------------------[ PRINT ]-------------------------------
print_info() {
  info title
  info underline
  section_software
  section_hardware
  section_connection
  section_local
  section_ambient
  section_uptime
}

# ---------------------------[ BEHAVIOR ]------------------------------
title_fqdn="off"
kernel_shorthand="on"
distro_shorthand="off"
os_arch="off"
uptime_shorthand="off"
memory_percent="off"
memory_unit="mib"
package_managers="on"
shell_path="off"
shell_version="on"
cpu_brand="off"
cpu_speed="off"
cpu_cores="logical"
cpu_temp="on"
gpu_type="integrated"
refresh_rate="on"
gtk_shorthand="on"
gtk2="on"
gtk3="on"
public_ip_host="http://ident.me"
public_ip_timeout=2
de_version="on"
disk_subtitle="dir"
disk_percent="on"
music_player="auto"
song_format="%artist% - %title%"
mpc_args=()

# ----------------------------[ LOOKS ]--------------------------------
colors=(distro)
underline_enabled="on"
underline_char="¨"
separator="›"
color_blocks="on"
block_width=3
block_height=1
col_offset="auto"
bar_char_elapsed="-"
bar_char_total="="
bar_border="on"
bar_length=15
bar_color_elapsed="distro"
bar_color_total="distro"

cpu_display="off"
memory_display="off"
battery_display="off"
disk_display="off"

# ----------------------------[ IMAGE ]--------------------------------
image_source="$HOME/.config/neofetch/ascii_logo.txt"
ascii_distro="auto"
ascii_bold="on"
image_loop="off"
thumbnail_dir="${XDG_CACHE_HOME:-${HOME}/.cache}/thumbnails/neofetch"

crop_mode="normal"
crop_offset="center"
image_size="auto"
gap=3
yoffset=0
xoffset=0
background_color=

# -----------------------------[ MISC ]--------------------------------
stdout="off"
